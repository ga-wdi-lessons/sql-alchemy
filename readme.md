# SQLAlchemy

## Learning Objectives

- Define ORM and why we use it over a database language.
- Explain what SQLAlchemy is and what problems it solves.
- Explain convention over configuration and how it relates to SQLAlchemy
- Define a class that inherits from SA
- Utilize SA to perform CRUD actions on a database
- Establish relationships with SA
- Seed a database using SA

## Framing

So far, you've learned how to interact with a database using SQL.

Specifically, you used postgresql. In today's lesson, we're doing to work with SQLite, which is similar, but distributable via the file system.

## Querying the DB w/ Python

Instead of interacting with the database directly via the CLI (using a tool like `psql`), we can use the `sqlite3` module to use Python to query the DB.

> See code/01-sqlite/app.py

[sqlite3 documentation](https://docs.python.org/2/library/sqlite3.html)

This is an improvement over executing SQL independently. A few problems still remain:

- Having to write both SQL and Python is confusing
- Susceptible to [SQL injection](http://www.acunetix.com/websitesecurity/sql-injection/) w/o sanitization
- Cursor is non-intuitive

## ORMs

### Doc Dive (5 mins)

Read the following docs

- https://en.wikipedia.org/wiki/Object-relational_mapping
- http://www.sqlalchemy.org/

### Turn and Talk (5 mins)

Now, turn & talk to your neighbor and discuss:

- At a high level, what are ORM's and how might they be useful?
- What is the importance of having an interface between python and the DB?

### Recap

- ORMs map tables to Python objects
  - `Person` in python corresponds to `person` sql table
- Really only need to use Python syntax w/ ORMs
- Use built-in python methods like `.filter` instead of SQL functions `LIKE`, `WHERE`

## SQLAlchemy

SQLAlchemy is one of [many Python ORMs](https://www.fullstackpython.com/object-relational-mappers-orms.html).

### We Do Person model and People Seeds

#### Install sqlalchemy

```
$ pip install sqlalchemy
```

#### Set up Class Definition (model) and DB Tables

```python
# person.py

from sqlalchemy import Column, Integer, String
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy import create_engine
Base = declarative_base()

class Person(Base):
    __tablename__ = 'person'
    # Here we define columns for the table person
    # Notice that each column is also a normal Python instance attribute.
    id = Column(Integer, primary_key=True)
    name = Column(String(250), nullable=False)

    # nicer output in the terminal
    def __repr__(self):
      return "Person(id=%r,name=%r)" % (self.id,self.name)

# Create an engine that stores data in the local directory's
# people.db file.
engine = create_engine('sqlite:///people.db')

# Create all tables in the engine. This is equivalent to "Create Table"
# statements in raw SQL.
Base.metadata.create_all(engine)
```

#### Seed the database

```python
# seeds.py
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from person import Base, Person

engine = create_engine('sqlite:///people.db')
# Bind the engine to the metadata of the Base class so that the
# declaratives can be accessed through a DBSession instance
Base.metadata.bind = engine

DBSession = sessionmaker(bind=engine)
# A DBSession() instance establishes all conversations with the database
# and represents a "staging zone" for all the objects loaded into the
# database session object. Any change made against the objects in the
# session won't be persisted into the database until you call
# session.commit(). If you're not happy about the changes, you can
# revert all of them back to the last commit by calling
# session.rollback()
session = DBSession()

# Insert a Person in the person table
session.add(Person(name='new person'))
session.add(Person(name='other third person'))
session.commit()

# Pause the program's execution and enter a repl
import code; code.interact(local=dict(globals(), **locals()))
```

### You do: NBA Stats Part 1

### Sync Up

### You do: NBA Stats Part 2

##  Relationships

#### ERDs

- An ERD is a tool we use to visualize and describe the data relating to the
  major entities that will exist in out programs.
- Ultimately lends itself to planning out and creating our database table
  structure.
- We keep our data separate from our behavior.
- There are multiple syntaxes or schemas for diagramming this data.  Here's a
  diagram for an orchard, generated by the `rails-erd` gem.

![erd](http://voormedia.github.io/rails-erd/images/orchard-bachman.png)

- The squares represent our entities and are filled with the attributes associated with our entity.
- The arrows between the squares indicate how the entities relate to one another.
  - There are several types of relationships:
    - One-to-many: An Company has many Orchards
    - Many-to-many: An Orchard has many PickingRobots and a PickingRobot works in many Orchards
      - Requires a join table.
    - One-to-one: A User has one Profile
      - Usually denotes that one entity should be an attribute of the other
      - Usually separated for physical space considerations

More relationship examples:
- one to one
  - fiancee has one fiancee
- one to many
  - one class has many students
- many to one
  - one student has many assignments
- many to many
  - one product has many orders
  - one order has many products

#### We Do: Library ERD Example

As a class, let's come up with an example ERD for an application that manages
a library.

### Exercise: Spotify ERD

In groups of 3, create your own ERD for Spotify. You can keep it as simple or
complex as you like.

At a minimum though, you should have Songs and Artists as entities.

### One to Many

A person has many addresses. An address belongs to a person.
The way we represent these relationships in a relational DB
is through the use of foreign keys.

#### Person

| id | name |
| --- | --- |
| 6 | Jesse |
| 7 | Scott |

#### Address

| id | street_name | street_number | post_code | person_id |
| --- | --- | --- | --- |--- |
| 1 | 34th Street | 8907 | 21740 | 6 |
| 2 | 15th Street | 1133 | 20002 | 6 |

Each address has a `person_id` field. You might want to think of this as "Each address belongs to a person"

## We do: Modify people from 02 to have many addresses

```python
# person.py

from sqlalchemy import Column, ForeignKey, Integer, String
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy import create_engine
from sqlalchemy.orm import relationship

Base = declarative_base()

class Person(Base):
    __tablename__ = 'person'
    # Here we define columns for the table person
    # Notice that each column is also a normal Python instance attribute.
    id = Column(Integer, primary_key=True)
    name = Column(String(250), nullable=False)

class Address(Base):
    __tablename__ = 'address'
    # Here we define columns for the table address.
    # Notice that each column is also a normal Python instance attribute.
    id = Column(Integer, primary_key=True)
    street_name = Column(String(250))
    street_number = Column(String(250))
    post_code = Column(String(250), nullable=False)
    person_id = Column(Integer, ForeignKey('person.id'))
    person = relationship(Person)
# Create an engine that stores data in the local directory's
# people.db file.
engine = create_engine('sqlite:///people.db')

# Create all tables in the engine. This is equivalent to "Create Table"
# statements in raw SQL.
Base.metadata.create_all(engine)
```

### You do:

Add a Job's model that belongs to a person: `A person has many jobs`

## Joins

SQL joins are required in order to implement many-to-many relationships.

![](http://media-www-asp.azureedge.net/media/48008/dbmanytomany.png)

In this example, a third table is created that does nothing but link the two other
tables together.

From one Instructor, we can find many courses by looking in the `CourseInstructor` table
where the instructor_id is the same.

From one Course, we can find many instructors by looking in the `CourseInstructor` table
where the course_id is the same.

### You do: Read

http://docs.sqlalchemy.org/en/latest/orm/tutorial.html#querying-with-joins
http://docs.sqlalchemy.org/en/latest/orm/tutorial.html#building-a-many-to-many-relationship

### You do:

Add a third model "Subject" to the harry potter example:

- A Student has many Subjects
- A Subject has many Students

## Further Reading

- https://blog.codinghorror.com/a-visual-explanation-of-sql-joins/
